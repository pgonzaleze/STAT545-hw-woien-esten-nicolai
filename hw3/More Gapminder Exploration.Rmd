---
title: "More Gapminder Exploration"
output: github_document
---

```{r, message=FALSE, warning=FALSE}
library(gapminder)
library(tidyverse)
source('code/Weighted Quantile.R')
```


## Task 1
*Report the absolute and/or relative abundance of countries with low life expectancy over time by continent: Compute some measure of worldwide life expectancy – you decide – a mean or median or some other quantile or perhaps your current age. Then determine how many countries on each continent have a life expectancy less than this benchmark, for each year.*





Let's calculate the life 10% percentile life expectancy for the world. To do this, we cannot simly use R's quantile function, as we need weighted quantiles


problem 1: computes the quantile for the first year, and uses that year as the quantile for all years

https://stackoverflow.com/questions/10220510/summary-statistics-by-two-or-more-factor-variables

First of all, lets manipulate the data, and add a field for the 10th percentile for life expectation. As the population of each country varies a lot, the percentile is weighted with the population. Click [here](code/Weighted_Quantile.md) to see how the weighted quantiles are computed. This is a bit technical, but we define the 10th percentile life expectancy as the following, 

*The 10th percentile life expectancy **q**, is such that 10 percent of the continent's population lives in a country with a lower or equal life expectancy than **q**, and 90 percent of the continent's population lives in a country with a higher or equal life expectancy than **q**. *

```{r}
gapminder.without.Oceania <- gapminder %>% 
  filter(continent != 'Oceania') %>% # Filter out Oceania as we don't have 
  droplevels()                       # enough observations for computing quantiles
  

# Group by year, such that we can compute the worlds 10th percentile life expectation for each year
dat.world <- gapminder.without.Oceania %>%
  group_by(year) %>% 
  mutate(lifeExp.10 = weighted.quantile(lifeExp, weight=as.numeric(pop), probs=0.1))

dat <- gapminder.without.Oceania %>% 
  group_by(continent, year)      %>% # We want to compute the 10th percentile life exp for each continent and each year
  mutate(lifeExp.10 = weighted.quantile(lifeExp, weight=as.numeric(pop), probs=0.1)) %>% 
  ungroup() %>%                      # Add the world's 10th percentile life expectancy
  add_row(continent='World', year=dat.world$year, lifeExp.10=dat.world$lifeExp.10)
```

```{r}
dat %>% 
  with(tapply(lifeExp.10, list(continent, year), mean)) %>% 
  knitr::kable()
```

https://stackoverflow.com/questions/13396662/get-list-of-colors-used-in-a-ggplot2-plot
```{r}
library(scales) # methods for plot scaling

dat %>% 
  ggplot(aes(x=year, color=continent)) + 
  geom_line(aes(y=lifeExp,group=country),alpha=0.1) + 
  geom_line(aes(y=lifeExp.10), size=1) + 
  scale_color_manual(values=c(scales::hue_pal()(5)[1:4], '#000000')) + # Gets ggplot's hue palette, and addes a black color to the palette, then colors the line with the new palette
  labs(title='10th Percentile Life Expectancy', x='Year', y='Life Expectancy')

```

Two observations. First, notice that after 1987, the 10th percentile life expectancy in Africa drops. This does not follow the rest of the world's trend, but can be explained by the outbreak of HIV and Aids. In addition, ovserve that almost all countries lower than the world's 10th percentile life expectation are African. 


https://stackoverflow.com/questions/6999144/how-do-you-create-a-bar-plot-for-two-variables-mirrored-across-the-x-axis-in-r
https://stackoverflow.com/questions/13734368/ggplot2-and-a-stacked-bar-chart-with-negative-values
```{r}
dat %>% 
  group_by(year,continent) %>% 
  mutate(pop = pop/sum(as.numeric(pop))) %>% 
  group_by(year) %>% 
  mutate(pop.over  = pop*(lifeExp>=lifeExp.10[continent=='World']),
         pop.under = pop*(lifeExp< lifeExp.10[continent=='World'])) %>% 
  filter(continent != 'World') %>% 
  group_by(year,continent) %>%
  summarize(pop.under = sum(pop.under), pop.over = sum(pop.over)) %>% 
  
  ggplot(aes(x=factor(year))) +
  geom_bar(aes(y=pop.under, group=continent, fill=continent), stat='identity', position='stack')
```



```{r}
dat %>% 
  group_by(year,continent) %>% 
  mutate(pop = pop/sum(as.numeric(pop))) %>% 
  group_by(year) %>% 
  mutate(pop.over  = pop*(lifeExp>=lifeExp.10[continent=='World']),
         pop.under = pop*(lifeExp< lifeExp.10[continent=='World'])) %>% 
  filter(continent != 'World')
```


```{r}
gapminder %>% 
  mutate(lifeExpChange = lifeExp - lag(lifeExp,1),
         didDecrease = pop*(lifeExpChange<0)) %>% 
  filter(year != min(year)) %>% 
  group_by(continent, year) %>% 
  summarize(s=sum(didDecrease)) %>% 
  ggplot(aes(x=year+2.5, y=s+0.0*(s==0), fill=continent)) + 
  geom_histogram(stat='identity', position='stack') +
  scale_x_continuous(breaks=seq(1952,2007,5))
```




```{r}
gapminder %>% 
  mutate(lifeExpChange = lifeExp - lag(lifeExp,1),
         didDecrease = lifeExpChange<0) %>% 
  filter(year != min(year)) %>% 
  group_by(continent, year) %>% 
  summarize(s=sum(didDecrease)) %>% 
  ggplot(aes(x=year, y=s+0.0*(s==0), fill=continent)) + 
  geom_histogram(stat='identity', position='stack')
```

```{r}
gapminder %>% 
  mutate(popChange = (pop - lag(pop,1))/pop) %>% 
  filter(year != min(year)) %>% 
  group_by(continent, year) %>% 
  ggplot(aes(x=year, y=popChange, color=continent)) + 
  geom_point(alpha=0.3, aes(size=pop)) + 
  geom_smooth(se=FALSE, aes(group=continent))
```



